<!doctype html>
<!--
  Course: DATA 300L 111 Spring 2020
  Author: Emily and Emma
-->
<html lang="en">

<head>
    <title>Broadway Shows</title>
    <meta charset="utf-8" />
    <link href="broadwayGross.css" rel="stylesheet" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        window.onload = () => {
            const broadway2015 = [{
                    "Show": "The Book of Mormon",
                    "AGP": 108.17
                },
                {
                    "Show": "The Lion King",
                    "AGP": 98.10
                }, {
                    "Show": "Aladdin",
                    "AGP": 97.27
                }, {
                    "Show": "Wicked",
                    "AGP": 97.08
                }, {
                    "Show": "Matilda",
                    "AGP": 71.75
                }, {
                    "Show": "Kinky Boots",
                    "AGP": 68.04
                }, {
                    "Show": "Les Miserables '14",
                    "AGP": 61.00
                }, {
                    "Show": "The Phantom of the Opera",
                    "AGP": 59.29
                }
            ];

            // set the dimensions and margins of the graph
            const margin = {
                    top: 20,
                    right: 40,
                    bottom: 30,
                    left: 20
                },
                width = 650 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;

            // append the svg object to the body of the page
            const barChart = d3.select("#bar-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const avgGP = 59.29;
            const barSpacing = 10;
            const strokeWidth = 2;


            d3.select("#bar-chart").append("figcaption")
                .text("Average Gross Potential of each Broadway show over the course of the entire year.");


            const values = [59.29, 61.00, 68.04, 71.75, 97.08, 97.27, 98.10, 108.17];

            // Add X axis
            //            const xScale = d3.scaleLinear()
            //                .domain([0, 110])
            //                .range([0, width - barSpacing]);

            const minData = 0;
            const maxData = 110;

            const xScale = d3.scaleLinear()
                .domain([minData, maxData])
                .range([0, width - barSpacing]);

            //Define X axis
            const xAxis = d3.axisBottom(xScale)
                .ticks(11)
                .tickValues([10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110]);


            barChart.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (height + 5) + ")")
                .call(xAxis);



            const bars = barChart.selectAll("g.bar")
                .remove()
                .exit()
                .data(broadway2015)
                .enter()
                .append("g")
                .attr("class", "bar")
                .on("click", toggleSelected)
                .on("dblclick", (d) => {
                    if (Number.isInteger(d["AGP"]))
                        displayItems(barChart, data);
                    else
                        displayItems(barChart, data, d["AGP"])
                });


            bars
                .append("rect")
                .attr("x", strokeWidth)
                .attr("y", (d, i) => i * height / broadway2015.length + strokeWidth)
                .attr("width", function(d) {
                    return xScale(d.AGP);
                })
                .attr("height", height / broadway2015.length - barSpacing)
                .style("stroke-width", strokeWidth);

            bars
                .append("text")
                .text(d => d["AGP"])
                .attr("x", d => d["AGP"] * 5.4)
                .attr("y", (d, i) => i * height / broadway2015.length + (height / broadway2015.length / 4.5 + barSpacing))
                .style("font-size", "11pt");

            bars
                .append("text")
                .text(d => d["Show"])
                .attr("x", 2 * barSpacing)
                .attr("y", (d, i) => i * height / broadway2015.length + (height / broadway2015.length / 4 + barSpacing))
                .style("fill", "black")
                .style("font-size", "11pt");

            function toggleSelected() {
                if (d3.select(this).attr("class") === "bar")
                    d3.select(this).attr("class", "bar selected");
                else
                    d3.select(this).attr("class", "bar");
            }



            //assign a class name to the labels to use in css for the hover
            //wrap them in the g tag 
            //create g tag called valueLabels 
            //append numerric labels in that grou and append show names to the svg file 

            // LINE CHART

            const margin2 = {
                top: 20,
                right: 100,
                bottom: 40,
                left: 100
            };
            const height2 = 500 - margin2.top - margin2.bottom;
            const width2 = 960 - margin2.left - margin2.right;

            const lineChart = d3.select("#line-chart").append("svg")
                .attr("width", width2 + margin2.left + margin2.right)
                .attr("height", height2 + margin2.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

            // setup scales - the domain is specified inside of the function called when we load the data
            //const x_Scale = d3.scaleTime().range([0, width2]);
            const x_Scale = d3.scaleTime()
                .domain([0, 500])
                .range([0, width2]);
            const y_Scale = d3.scaleLinear().range([height2, 0]);
            const color = d3.scaleOrdinal(d3.schemeCategory10);


            // Add scales to axis
            const y_axis = d3.axisLeft()
                .scale(y_Scale);

            // Add scales to axis
            const x_axis = d3.axisBottom()
                .scale(x_Scale);

            //Append group and insert axis
            lineChart.append("g")
                .call(y_axis);
            lineChart.append("g")
                .call(x_axis);

            // create function to parse dates into date objects
            const parseDate = d3.timeParse("%Y-%m-%d");
            //const formatDate = d3.timeFormat("%Y-%m-%d");
            const bisectDate = d3.bisect(function(d) {
                return d.date;
            }).left;

            // set the line attributes
            const line = d3.line()
                //.interpolate("basis")
                .x(function(d) {
                    return x_Scale(d.date);
                })
                .y(function(d) {
                    return y_Scale(d.close);
                });

            const focus = lineChart.append("g").style("display", "none");

            // import data and create chart 
            d3.csv("https://cors-anywhere.herokuapp.com/dataProfit2015.csv", function(d) {
                    return {
                        date: parseDate(d.date),
                        Aladdin: +d.Aladdin,
                        KinkyBoots: +d.KinkyBoots,
                        Facebook: +d.Facebook,
                        LesMiserables14: +d.LesMiserables14,
                        Matilda: +d.Matilda,
                        TheBookofMormon: +d.TheBookofMormon,
                        TheLionKing: +d.TheLionKing,
                        ThePhantomOfTheOpera: +d.ThePhantomOfTheOpera,
                        Wicked: +d.Wicked

                    };
                },
                function(error, data) {

                    // sort data ascending - needed to get correct bisector results
                    data.sort(function(a, b) {
                        return a.date - b.date;
                    });

                    // color domain
                    color.domain(d3.keys(data[0]).filter(function(key) {
                        return key !== "date";
                    }));

                    // create profits array with object for each show containing all data
                    const profits = color.domain().map(function(name) {
                        return {
                            name: name,
                            values: data.map(function(d) {
                                return {
                                    date: d.date,
                                    close: d[name]
                                };
                            })
                        };
                    });

                    // add domain ranges to the x and y scales
                    x_Scale.domain([
                        d3.min(profits, function(c) {
                            return d3.min(c.values, function(v) {
                                return v.date;
                            });
                        }),
                        d3.max(profits, function(c) {
                            return d3.max(c.values, function(v) {
                                return v.date;
                            });
                        })
                    ]);
                    y_Scale.domain([
                        0,
                        // d3.min(stocks, function(c) { return d3.min(c.values, function(v) { return v.close; }); }),
                        d3.max(profits, function(c) {
                            return d3.max(c.values, function(v) {
                                return v.close;
                            });
                        })
                    ]);

                    // add the x axis
                    lineChart.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height2 + ")")
                        .call(x_Axis);

                    // add the y axis
                    lineChart.append("g")
                        .attr("class", "y axis")
                        .call(yAxis)
                        .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", -60)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text("Gross ($)");

                    // add circle at intersection
                    focus.append("circle")
                        .attr("class", "y")
                        .attr("fill", "none")
                        .attr("stroke", "black")
                        .style("opacity", 0.5)
                        .attr("r", 8);

                    // add horizontal line at intersection
                    focus.append("line")
                        .attr("class", "x")
                        .attr("stroke", "black")
                        .attr("stroke-dasharray", "3,3")
                        .style("opacity", 0.5)
                        .attr("x1", 0)
                        .attr("x2", width2);

                    // add vertical line at intersection
                    focus.append("line")
                        .attr("class", "y")
                        .attr("stroke", "black")
                        .attr("stroke-dasharray", "3,3")
                        .style("opacity", 0.5)
                        .attr("y1", 0)
                        .attr("y2", height2);

                    // append rectangle for capturing if mouse moves within area
                    lineChart.append("rect")
                        .attr("width", width2)
                        .attr("height", height2)
                        .style("fill", "none")
                        .style("pointer-events", "all")
                        .on("mouseover", function() {
                            focus.style("display", null);
                        })
                        .on("mouseout", function() {
                            focus.style("display", "none");
                        })
                        .on("mousemove", mousemove);

                    // add the line groups
                    const profit = svg.selectAll(".showXYZ")
                        .data(profits)
                        .enter().append("g")
                        .attr("class", "showXYZ");

                    // add the stock price paths
                    profit.append("path")
                        .attr("class", "line")
                        .attr("id", function(d, i) {
                            return "id" + i;
                        })
                        .attr("d", function(d) {
                            return line(d.values);
                        })
                        .style("stroke", function(d) {
                            return color(d.name);
                        });


                    // add the stock labels at the right edge of chart
                    const maxLength = data.length;
                    profit.append("text")
                        .datum(function(d) {
                            return {
                                name: d.name,
                                value: d.values[maxLength - 1]
                            };
                        })
                        .attr("transform", function(d) {
                            return "translate(" + x_Scale(d.value.date) + "," + y_Scale(d.value.close) + ")";
                        })
                        .attr("id", function(d, i) {
                            return "text_id" + i;
                        })
                        .attr("x", 3)
                        .attr("dy", ".35em")
                        .text(function(d) {
                            return d.name;
                        })
                        .on("mouseover", function(d, i) {
                            for (j = 0; j < 6; j++) {
                                if (i !== j) {
                                    d3.select("#id" + j).style("opacity", 0.1);
                                    d3.select("#text_id" + j).style("opacity", 0.2);
                                }
                            };
                        })
                        .on("mouseout", function(d, i) {
                            for (j = 0; j < 6; j++) {
                                d3.select("#id" + j).style("opacity", 1);
                                d3.select("#text_id" + j).style("opacity", 1);
                            };
                        });

                    // mousemove function
                    function mousemove() {

                        const x0 = x_Scale.invert(d3.mouse(this)[0]);
                        const i = bisectDate(data, x0, 1); // gives index of element which has date higher than x0
                        const d0 = data[i - 1],
                            d1 = data[i];
                        const d = x0 - d0.date > d1.date - x0 ? d1 : d0;
                        const close = d3.max([+d.Aladdin, +d.KinkyBoots, +d.LesMiserables14, +d.Matilda, +d.TheBookofMormon, +d.TheLionKing, +d.ThePhantomOfTheOpera, +d.Wicked]);


                        focus.select("circle.y")
                            .attr("transform", "translate(" + x_Scale(d.date) + "," + yS_cale(close) + ")");

                        focus.select("line.y")
                            .attr("y2", height - yScale(close))
                            .attr("transform", "translate(" + x_Scale(d.date) + "," +
                                y_Scale(close) + ")");

                        focus.select("line.x")
                            .attr("x2", xScale(d.date))
                            .attr("transform", "translate(0," +
                                (y_Scale(close)) + ")");

                    };

                });
        }
    </script>
</head>

<body>
    <h1>Top Grossing Broadway Shows 2015</h1>
    <p> The charts below display data regarding the top grossing Broadway shows that aired every week during 2015. The line chart will show the monthly average profit of each Broadway show and the bar chart will show how well they met their potential profit.</p>
    <section>
        <h2>Line Graph </h2>
        <figure id="line-chart"></figure>
    </section>
    <section>
        <h2>Gross Potential of Broadway Shows</h2>
        <p>The Gross Potential is the maximum amount a show can possibly earn based on calculations involving ticket prices, seating capacity, and the number of performances. This number is expressed here as a percentage of what could have been achieved (Gross Gross / Gross Potential).</p>
        <p>Hover over any bar to see the Broadway show name and its gross potential percentage. Click to select and highlight for easier comparison.</p>
        <figure id="bar-chart"></figure>
        <!--        <p2>We can notice in the chart above that although these shows were the most profitable in 2015, they could have achieved higher gross values.</p2>-->
    </section>

    <section>
        <p>
            Sources: (include here)
        </p>
    </section>

</body></html>
